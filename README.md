# CAFE: CArtoonize For Extra faces

## TEAM Member
<table align="center">
    <th colspan=5>ë¸”ë™ë°•ìŠ¤</th>
    <tr height="160px">
        <td align="center" width="150px">
            <a href="https://github.com/kimk-ki"><img height="120px" width="120px" src="https://avatars.githubusercontent.com/u/110472164?v=4"/></a>
            <br />
            <a href="https://github.com/kimk-ki"><strong>ğŸ™ˆ ê¹€ê¸°ìš©</strong></a>
            <br />
        </td>
        <td align="center" width="150px">
            <a href="https://github.com/SeongSuKim95"><img height="120px" width="120px" src="https://avatars.githubusercontent.com/u/62092317?v=4"/></a>
            <br/>
            <a href="https://github.com/SeongSuKim95"><strong>ğŸ’ ê¹€ì„±ìˆ˜</strong></a>
            <br />
        </td>
        <td align="center" width="150px">
            <a href="https://github.com/juye-ops"><img height="120px" width="120px" src="https://avatars.githubusercontent.com/u/103459155?v=4"/></a>
            <br/>
            <a href="https://github.com/juye-ops"><strong>ğŸ™‰ ê¹€ì£¼ì—½</strong></a>
            <br />
        </td>
        <td align="center" width="150px">
            <a href="https://github.com/99sphere"><img height="120px" width="120px" src="https://avatars.githubusercontent.com/u/59161083?v=4"/></a>
            <br />
            <a href="https://github.com/99sphere"><strong>ğŸ™Š ì´  êµ¬</strong></a>
            <br />
        </td>
        <td align="center" width="150px">
            <a href="https://github.com/thlee00"><img height="120px" width="120px" src="https://avatars.githubusercontent.com/u/56151577?v=4"/></a>
            <br/>
            <a href="https://github.com/thlee00"><strong>ğŸµ ì´íƒœí¬</strong></a>
            <br />
        </td>
    </tr>
</table>

- ê¹€ê¸°ìš©_T4020: Cartoonize ëª¨ë¸ ì¡°ì‚¬, ì‹¤í—˜ ê²°ê³¼ ë¶„ì„
- ê¹€ì„±ìˆ˜_T4039: Object Tracking ëª¨ë¸ ì¡°ì‚¬, Modeling, ì•Œê³ ë¦¬ì¦˜ ê°œë°œ
- ê¹€ì£¼ì—½_T4048: Model Serving
- ì´  êµ¬_T4145: Cartoonize ëª¨ë¸ ì¡°ì‚¬, Modeling, ì•Œê³ ë¦¬ì¦˜ ê°œë°œ
- ì´íƒœí¬_T4172: Object Tracking ëª¨ë¸ ì¡°ì‚¬, Modeling, ì½”ë“œ ì˜¤ë¥˜ ë¶„ì„ ë° ìˆ˜ì •
---

## Project Outline

<table>
    <tr>
        <td align="center">
            <a><img height="200px" width="500px" src="https://user-images.githubusercontent.com/59161083/216925652-aa5b48f9-9225-4d1f-8f90-d252b0ecce46.png"/></a>
            <br />
        </td>
        <td align="center">
            <a><img height="200px" width="500px" src="https://user-images.githubusercontent.com/59161083/216926107-e4413d9c-eee4-4722-85bc-f1bef7ceef00.png"/></a>
            <br/>
        </td>
    </tr>
</table>

- TV í”„ë¡œê·¸ë¨ í˜¹ì€ ìœ íŠœë¸Œë¥¼ ë³´ë‹¤ë³´ë©´, ë©”ì¸ ì¶œì—°ìê°€ ì•„ë‹Œ ì´ë“¤ì˜ ì–¼êµ´ì„ ëª¨ìì´í¬ ëœ ê²ƒì„ ì‰½ê²Œ ì°¾ì•„ë³¼ ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ ì´ëŸ¬í•œ ëª¨ìì´í¬ ê¸°ë²•ì€ ì–¼êµ´ì˜ íŠ¹ì§•ì„ ì§€ì›Œë²„ë¦¬ê¸° ë•Œë¬¸ì— ì¸ë¬¼ì˜ ì–¼êµ´ í‘œì •, ëˆˆë¹›, ì‹œì„ ê³¼ ê°™ì€ ì •ë³´ë¥¼ ìƒê²Œ ëœë‹¤. 

<table>
    <tr>
        <td align="center">
            <a><img height="200px" width="500px" src="https://user-images.githubusercontent.com/59161083/216928691-458d84a1-37be-4690-93d2-52106c94c898.png"/></a>
            <br />
        </td>
        <td align="center">
            <a><img height="200px" width="500px" src="https://user-images.githubusercontent.com/59161083/216928817-dffec866-bafe-49f4-8c89-9e82621d7807.png"/></a>
            <br/>
        </td>
    </tr>
</table>

- ìœ„ì˜ ì‚¬ì§„ë“¤ì€ 'ë°±ì¢…ì›ì˜ ì¿ í‚¹ë¡œê·¸'ë¼ëŠ” ìœ íŠœë¸Œ ì±„ë„ì—ì„œ ê°€ì ¸ì˜¨ ê²ƒìœ¼ë¡œ, ì¼ë°˜ì¸ì˜ í‘œì •ê³¼ ëŒ€ì‘ë˜ëŠ” ë°±ì¢…ì›ì˜ ì‚¬ì§„ìœ¼ë¡œ ëŒ€ì²´í•¨ìœ¼ë¡œì¨ ê·¸ë“¤ì˜ ë°˜ì‘ì„ íš¨ê³¼ì ìœ¼ë¡œ íŒŒì•…í•  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ë‹¤. 
- í•˜ì§€ë§Œ, ì´ëŸ¬í•œ ë°©ì‹ì€ í¸ì§‘ìê°€ ì§ì ‘ í•´ë‹¹ í”„ë ˆì„ì˜ ì–¼êµ´ì„ ì°¾ì•„ ë°”ê¿”ì£¼ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ìƒë‹¹í•œ ë¹„ìš©(ì‹œê°„, ë…¸ë ¥ ë“±)ì´ ë°œìƒí•œë‹¤.
- ì´ì— ìš°ë¦¬ëŠ” ê¸°ì¡´ì˜ ëª¨ìì´í¬ë¥¼ ëŒ€ì²´í•˜ì—¬ ì‚¬ëŒì„ íŠ¹ì •í•  ìˆ˜ ìˆì„ ì •ë„ë¡œ ì–¼êµ´ì„ ë…¸ì¶œì‹œí‚¤ì§€ ì•ŠëŠ” ë™ì‹œì— ì–¼êµ´ í‘œì •, ì‹œì„ , ëˆˆë¹›ê³¼ ê°™ì€ ì •ë³´ëŠ” ë³´ì¡´í•  ìˆ˜ ìˆëŠ” ìƒˆë¡œìš´ ë°©ì‹, `CAFE(CArtoonize For Extra faces)`ë¥¼ ì œì•ˆí•œë‹¤.
---

## Environment
- Ubuntu 18.04.5 LTS
- Intel(R) Xeon(R) Gold 5120 CPU @ 2.20GHz
- NVIDIA Tesla V100-SXM2-32GB (used up to 8GB at our test)
- CUDA 11.0
- Tensorflow 1.12.0
- PyTorch 1.12.1
- opencv-python 4.2.0.34

---

## Architecture
### Summary
- Detection: [YOLOv7](https://github.com/derronqi/yolov7-face) 
- Tracking: [BoT-SORT](https://github.com/NirAharon/BoT-SORT)
- Cartoonize : [White-box-Cartoonization](https://github.com/SystemErrorWang/White-box-Cartoonization)
- Backend: FastAPI
- Frontend: Streamlit

### Data Flow
<table>
        <td align="center">
            <a><img height="300px" width="800px" src="https://user-images.githubusercontent.com/59161083/216927654-a4676796-80a2-4802-bdba-97449debbf39.png"/></a>
            <br/>
        </td>
</table>

ì „ì²´ì ì¸ Data FlowëŠ” ì•„ë˜ì™€ ê°™ë‹¤.    

> 1. Userë¡œë¶€í„° ì˜ìƒê³¼ ì˜ìƒì˜ ì£¼ì¸ê³µ(target) ì‚¬ì§„ì„ ì…ë ¥ë°›ëŠ”ë‹¤.   
> 2. ì˜ìƒì— face detection & tracking, cartoonizeë¥¼ ì ìš©í•œë‹¤.     
    2-1. ì˜ìƒì— ëŒ€í•œ face detection, trackingì„ í†µí•˜ì—¬ ëª¨ë“  ë“±ì¥ì¸ë¬¼ì˜ ì–¼êµ´ ì •ë³´ë¥¼ ì–»ëŠ”ë‹¤.    
    2-2. ì˜ìƒì˜ ëª¨ë“  í”„ë ˆì„ì— ëŒ€í•œ cartoonizeë¥¼ ì§„í–‰í•œë‹¤.
> 3. ì£¼ì¸ê³µ ì‚¬ì§„ê³¼ ì˜ìƒì— ë“±ì¥í•˜ëŠ” ì¸ë¬¼ë“¤ì˜ ì‚¬ì§„ì— ëŒ€í•œ featureë¥¼ ë½‘ì•„ë‚¸ í›„, cosine similarityë¥¼ ê³„ì‚°í•˜ì—¬ targetê³¼ targetì´ ì•„ë‹Œ ì–¼êµ´ë“¤ì„ êµ¬ë¶„í•œë‹¤. 
> 4. targetì´ ì•„ë‹Œ ì–¼êµ´ë“¤ì— ëŒ€í•œ ì •ë³´(from 2-1)ë¥¼ ì´ìš©í•˜ì—¬, ëª¨ë“  í”„ë ˆì„ì˜ ì–¼êµ´ì„ swap í•œë‹¤. 

### Service Flow
<table>
        <td align="center">
            <a><img height="300px" width="1000px" src="https://user-images.githubusercontent.com/59161083/216934011-ef53c2f2-f144-4e21-a465-a65935dcd0b5.png"/></a>
            <br/>
        </td>
</table>

ì „ì²´ì ì¸ Service FlowëŠ” ì•„ë˜ì™€ ê°™ë‹¤.    
> 1. Streamlitì„ í†µí•´ userì™€ interactioní•˜ë©°, ì£¼ì¸ê³µ ì´ë¯¸ì§€ì™€ ì˜ìƒì„ ì…ë ¥ë°›ê³ , ê²°ê³¼ë¬¼ì„ ë‹¤ìš´ë°›ì„ ìˆ˜ ìˆë‹¤.    
> 2. Streamlitì„ í†µí•´ ì…ë ¥ë°›ì€ ì´ë¯¸ì§€ì™€ ì˜ìƒì€ local file storageì— ì €ì¥ë˜ë©°, FastAPIë¥¼ í†µí•´ Detection & Tracking, Cartoonize ì—°ì‚°ì„ ìš”ì²­í•œë‹¤.
> 3. Detection & Trackingì€ PyTorch í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ê³ , CartoonizeëŠ” Tensorflow í™˜ê²½ì—ì„œ ì‹¤í–‰ëœë‹¤. ì´ ê³¼ì •ì€ ë³‘ë ¬ì ìœ¼ë¡œ ì§„í–‰ë˜ë©°, Tracking ê²°ê³¼ëŠ” MongoDBì— ì €ì¥ëœë‹¤. 
> 4. ìœ„ì˜ ê³¼ì •ì´ ëë‚œ ì´í›„, backendì—ì„œ MongoDBì— ì €ì¥ëœ tracking ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ face swapping ê³¼ì •ì„ ìˆ˜í–‰í•œë‹¤.
> 5. Streamlitì„ í†µí•´ userê°€ ìµœì¢… ê²°ê³¼ë¬¼ì˜ ì¬ìƒ ë° ì €ì¥ì´ ê°€ëŠ¥í•˜ë‹¤. 

---

## Usage
### Environment Setup
- To use any form of function we provide, the following process must be followed.

```(python)
# Clone our repository
git clone https://github.com/boostcampaitech4lv23cv1/final-project-level3-cv-07

# Move to our dir
cd final-project-level3-cv-07

# Setup for each virtual environment (for frontend, backend, detection & tracking, cartoonize)
bash init.sh
```

- Then, follow instruction in [Dataset section](#dataset)

### Run CAFE with Web Demo

```(python)
# Open frontend/app.py and update backend ip address in line 14
vim frontend/app.py

"""
fix below line
backend = "http://115.85.182.51:30002" -> backend = "http://{your_own_ip_address}:30002"
"""

# Start all process required for starting demo page
bash start.sh

# Now, you can access demo page at "http://{your_own_ip_address}:30001"}
```

### Run CAFE without Web Demo (WIP)
- Unfortunately, we haven't checked the file path yet. Do it yourself if you need to.

- You can also run CAFE without web demo. Just run the python file in the order below.

> 1. Run cartoonize function (models/cartoonize/Cartoonize.py)
```(python)
cd final-project-level3-cv-07/models/cartoonize
python Cartoonize.py
```
> 2. Run tracking, face swapping and save result
```(python)
cd final-project-level3-cv-07/models/track
python tools/mc_demo_yolov7.py
```

---

## Dataset
### YOLOv7-tiny
Trained with [WiderFace](http://shuoyang1213.me/WIDERFACE/), [[pretrained weights](https://drive.google.com/u/0/uc?id=1Mona-I4PclJr5mjX1qb8dgDeMpYyBcwM&export=download)]   
Download the pre-trained weights and place them in the path below.

`./final-project-level3-cv-07/models/track/pretrained`

### White-box Cartoonization

Trained with private dataset. Scenery images are collected from Shinkai Makoto, Miyazaki Hayao and Hosoda Mamoru films. Portrait images are from Kyoto animations and PA Works). [[pretrained weights](https://github.com/SystemErrorWang/White-box-Cartoonization/tree/master/test_code/saved_models)]    
Download the pre-trained weights and place them in the path below. (maybe, already exist)

`./final-project-level3-cv-07/models/cartoonize/saved_models`

---

## Result
### Discussion
- ì²« ë²ˆì§¸ ê²°ê³¼ì˜ tracking resultë¥¼ ë³´ë©´ ë°°ê²½ ë° ì˜ìƒì—ì„œë„ ì–¼êµ´ì´ ì¸ì‹ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. CAFEëŠ” confidence thresholdingì„ í†µí•´ ì´ëŸ¬í•œ ìƒí™©ì—ì„œë„ ê°•ì¸í•˜ê²Œ ë™ì‘í•œë‹¤. 
- ë‘ ë²ˆì§¸, ì„¸ ë²ˆì§¸ ê²°ê³¼ë¥¼ ë³´ë©´ í™”ë©´ ì „í™˜ì— ì˜í•´ ë™ì¸ ì¸ë¬¼ì— ëŒ€í•œ ì—¬ëŸ¬ê°œì˜ trackletì´ ìƒì„±ë˜ì§€ë§Œ, ìš°ë¦¬ê°€ ì œì•ˆí•œ two-step similarity check ê³¼ì •ì„ í†µí•´ ì„±ê³µì ìœ¼ë¡œ targetê³¼ extraë¥¼ êµ¬ë¶„í•´ë‚´ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<table align="center">
    <tr>
        <td align="center">
            target
            <br />
        </td>
        <td align="center">
            tracking result
            <br />
        </td>
        <td align="center">
            CAFE result
            <br />
        </td>
    </tr>
    <tr>
        <td align="center">
            <a><img height="150px" width="110px" src="https://user-images.githubusercontent.com/59161083/217132894-5f717969-d4a3-467f-a3bb-529e10a1c0d7.jpg"/></a>
            <br />
        </td>
        <td align="center">
            <a><img height="150px" width="300px" src="https://user-images.githubusercontent.com/59161083/217134468-18233e3e-1ff4-4e00-9e53-9abf891cc91f.gif"/></a>
            <br />
        </td>
        <td align="center">
            <a><img height="150px" width="300px" src="https://user-images.githubusercontent.com/59161083/217132389-aa5e89e2-49d2-46d8-b0df-111e24cd0e10.gif"/></a>
            <br/>
        </td>
    </tr>
    <tr>
        <td align="center">
            <a><img height="150px" width="110px" src="https://user-images.githubusercontent.com/59161083/217133395-945b7978-191e-46e3-b4fc-8d538469d778.jpg"/></a>
            <br />
        </td>
        <td align="center">
            <a><img height="150px" width="300px" src="https://user-images.githubusercontent.com/59161083/217134297-5832a155-4492-4fc9-80a1-73449ac482ab.gif"/></a>
            <br />
        </td>
        <td align="center">
            <a><img height="150px" width="300px" src="https://user-images.githubusercontent.com/59161083/217133332-bd47f2d4-c259-4549-adb5-b2dfafc320fe.gif"/></a>
            <br/>
        </td>
    </tr>
    <tr>
        <td align="center">
            <a><img height="150px" width="110px" src="https://user-images.githubusercontent.com/59161083/217133674-38115128-adca-49aa-96f6-45cec7a04335.jpg"/></a>
            <br />
        </td>
        <td align="center">
            <a><img height="150px" width="300px" src="https://user-images.githubusercontent.com/59161083/217134585-48bb55a8-cbe4-405b-a952-ee2a26f58e4e.gif"/></a>
            <br />
        </td>
        <td align="center">
            <a><img height="150px" width="300px" src="https://user-images.githubusercontent.com/59161083/217134065-97e8c4c2-577e-4856-b242-9a99bd219319.gif"/></a>
            <br/>
        </td>
    </tr>
</table>

### ì˜ìƒ ì¶œì²˜
- https://www.youtube.com/watch?v=SP-LJqVgQuw&t=163s
- https://www.youtube.com/watch?v=GmAwsAB7nhw
- https://www.youtube.com/watch?v=tL20swtWOqI

---

## Demo
<table align="center">
    <tr>
        <td align="center">
            <a><img src="https://user-images.githubusercontent.com/59161083/217577486-2f95abb3-2599-4649-8fba-af5cb09a9f87.gif"/></a>
            <br />
        </td>
    </tr>
</table>

---
## More Details
[[Wrap-up Report ì¶”ê°€]()] [[Slides ì¶”ê°€]()] [[Presentation ì¶”ê°€]()]

---
## Reference
- C.-Y. Wang, A. Bochkovskiy, H.-Y. M. Liao, Yolov7: Trainable bag-
of-freebies sets new state-of-the-art for real-time object detectors, arXiv
preprint arXiv:2207.02696.
- N. Aharon, R. Orfaig, B.-Z. Bobrovsky, Bot-sort: Robust associations
multi-pedestrian tracking, arXiv preprint arXiv:2206.14651.
- X. Wang, J. Yu, Learning to cartoonize using white-box cartoon represen-
tations, in: Proceedings of the IEEE/CVF conference on computer vision
and pattern recognition, 2020, pp. 8090â€“8099.

---
## Acknowledgement
A large part of the code are borrowed from [YOLOv7 with wider face dataset](https://github.com/derronqi/yolov7-face), [BoT-SORT](https://github.com/NirAharon/BoT-SORT), [White-box-Cartoonization](https://github.com/SystemErrorWang/White-box-Cartoonization). Thanks for their excellent work and sharing.


<div align=center>
	<a href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fgithub.com%2Fboostcampaitech4lv23cv1%2Ffinal-project-level3-cv-07&count_bg=%2379C83D&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=hits&edge_flat=false"/></a>
</div>